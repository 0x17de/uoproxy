package packets

/*

http://necrotoolz.sourceforge.net/kairpacketguide/
https://docs.polserver.com/packets/index.php
http://www.hoogi.de/wolfpack/wiki/doku.php?id=uo_protocol

*/

import (
	"bytes"
	"strings"
)

type Packeter interface {
	Base() *BasePacket
	Bytes() []byte
	Read(chan byte)
}
type BasePacket struct {
	Info           PacketInfo
	ClientToServer bool
}

func (b *BasePacket) Base() *BasePacket {
	return b
}
func (b *BasePacket) Writer() *BOut {
	return NewBOut(b.Info)
}

func (b *BasePacket) uint(in chan byte) uint {
	var o uint = 0
	for i := 3; i >= 0; i-- {
		o += uint(<-in) << (i * 8)
	}
	return o
}

func (b *BasePacket) short(in chan byte) int {
	r := int(<-in) << 8
	r += int(<-in)
	return r
}

func (b *BasePacket) bstr(in chan byte, l int) []byte {
	var o bytes.Buffer
	for i := 0; i < l; i++ {
		o.WriteByte(<-in)
	}
	return o.Bytes()
}

func (b *BasePacket) zstrFixed(in chan byte, l int) string {
	var o strings.Builder
	done := false
	for i := 0; i < l; i++ {
		c := <-in
		if !done {
			if c == 0 {
				done = true
			} else {
				o.WriteByte(c)
			}
		}
	}
	return o.String()
}

type PacketInfo struct {
	Id      int
	Size    int
	Handler Packeter
}

var PacketMap = map[int]PacketInfo{
	0x00: {Id: 0x00, Size: 0x68},
	0x01: {Id: 0x01, Size: 0x05},
	0x02: {Id: 0x02, Size: 0x07, Handler: &MoveRequestPacket{}},
	0x03: {Id: 0x03, Size: -1},
	0x04: {Id: 0x04, Size: 0x02},
	0x05: {Id: 0x05, Size: 0x05},
	0x06: {Id: 0x06, Size: 0x05},
	0x07: {Id: 0x07, Size: 0x07},
	0x08: {Id: 0x08, Size: 0x0e},
	0x09: {Id: 0x09, Size: 0x05},
	0x0A: {Id: 0x0A, Size: 0x0b},
	0x0B: {Id: 0x0B, Size: 0x07},
	0x0C: {Id: 0x0C, Size: -1},
	0x0D: {Id: 0x0D, Size: 0x03},
	0x0E: {Id: 0x0E, Size: 0x01},
	0x0F: {Id: 0x0F, Size: 0x3d},
	0x10: {Id: 0x10, Size: 0xd7},
	0x11: {Id: 0x11, Size: -1},
	0x12: {Id: 0x12, Size: -1},
	0x13: {Id: 0x13, Size: 0x0a},
	0x14: {Id: 0x14, Size: 0x06},
	0x15: {Id: 0x15, Size: 0x09},
	0x16: {Id: 0x16, Size: 0x01},
	0x17: {Id: 0x17, Size: -1},
	0x18: {Id: 0x18, Size: -1},
	0x19: {Id: 0x19, Size: -1},
	0x1A: {Id: 0x1A, Size: -1},
	0x1B: {Id: 0x1B, Size: 0x25},
	0x1C: {Id: 0x1C, Size: -1, Handler: &SendSpeechPacket{}},
	0x1D: {Id: 0x1D, Size: 0x05},
	0x1E: {Id: 0x1E, Size: 0x04},
	0x1F: {Id: 0x1F, Size: 0x08},
	0x20: {Id: 0x20, Size: 0x13},
	0x21: {Id: 0x21, Size: 0x08},
	0x22: {Id: 0x22, Size: 0x03, Handler: &MovePacket{}},
	0x23: {Id: 0x23, Size: 0x1a},
	0x24: {Id: 0x24, Size: 0x07},
	0x25: {Id: 0x25, Size: 0x14},
	0x26: {Id: 0x26, Size: 0x05},
	0x27: {Id: 0x27, Size: 0x02},
	0x28: {Id: 0x28, Size: 0x05},
	0x29: {Id: 0x29, Size: 0x01},
	0x2A: {Id: 0x2A, Size: 0x05},
	0x2B: {Id: 0x2B, Size: 0x02},
	0x2C: {Id: 0x2C, Size: 0x02},
	0x2D: {Id: 0x2D, Size: 0x11},
	0x2E: {Id: 0x2E, Size: 0x0f},
	0x2F: {Id: 0x2F, Size: 0x0a},
	0x30: {Id: 0x30, Size: 0x05},
	0x31: {Id: 0x31, Size: 0x01},
	0x32: {Id: 0x32, Size: 0x02},
	0x33: {Id: 0x33, Size: 0x02},
	0x34: {Id: 0x34, Size: 0x0a},
	0x35: {Id: 0x35, Size: 0x28d},
	0x36: {Id: 0x36, Size: -1},
	0x37: {Id: 0x37, Size: 0x08},
	0x38: {Id: 0x38, Size: 0x07},
	0x39: {Id: 0x39, Size: 0x09},
	0x3A: {Id: 0x3A, Size: -1},
	0x3B: {Id: 0x3B, Size: -1},
	0x3C: {Id: 0x3C, Size: -1},
	0x3D: {Id: 0x3D, Size: 0x02},
	0x3E: {Id: 0x3E, Size: 0x25},
	0x3F: {Id: 0x3F, Size: -1},
	0x40: {Id: 0x40, Size: 0xc9},
	0x41: {Id: 0x41, Size: -1},
	0x42: {Id: 0x42, Size: -1},
	0x43: {Id: 0x43, Size: 0x229},
	0x44: {Id: 0x44, Size: 0x2c9},
	0x45: {Id: 0x45, Size: 0x05},
	0x46: {Id: 0x46, Size: -1},
	0x47: {Id: 0x47, Size: 0x0b},
	0x48: {Id: 0x48, Size: 0x49},
	0x49: {Id: 0x49, Size: 0x5d},
	0x4A: {Id: 0x4A, Size: 0x05},
	0x4B: {Id: 0x4B, Size: 0x09},
	0x4C: {Id: 0x4C, Size: -1},
	0x4D: {Id: 0x4D, Size: -1},
	0x4E: {Id: 0x4E, Size: 0x06},
	0x4F: {Id: 0x4F, Size: 0x02},
	0x50: {Id: 0x50, Size: -1},
	0x51: {Id: 0x51, Size: -1},
	0x52: {Id: 0x52, Size: -1},
	0x53: {Id: 0x53, Size: 0x02},
	0x54: {Id: 0x54, Size: 0x0c},
	0x55: {Id: 0x55, Size: 0x01},
	0x56: {Id: 0x56, Size: 0x0b},
	0x57: {Id: 0x57, Size: 0x6e},
	0x58: {Id: 0x58, Size: 0x6a},
	0x59: {Id: 0x59, Size: -1},
	0x5A: {Id: 0x5A, Size: -1},
	0x5B: {Id: 0x5B, Size: 0x04},
	0x5C: {Id: 0x5C, Size: 0x02},
	0x5D: {Id: 0x5D, Size: 0x49},
	0x5E: {Id: 0x5E, Size: -1},
	0x5F: {Id: 0x5F, Size: 0x31},
	0x60: {Id: 0x60, Size: 0x05},
	0x61: {Id: 0x61, Size: 0x09},
	0x62: {Id: 0x62, Size: 0x0f},
	0x63: {Id: 0x63, Size: 0x0d},
	0x64: {Id: 0x64, Size: 0x01},
	0x65: {Id: 0x65, Size: 0x04},
	0x66: {Id: 0x66, Size: -1},
	0x67: {Id: 0x67, Size: 0x15},
	0x68: {Id: 0x68, Size: -1},
	0x69: {Id: 0x69, Size: -1},
	0x6A: {Id: 0x6A, Size: 0x03},
	0x6B: {Id: 0x6B, Size: 0x09},
	0x6C: {Id: 0x6C, Size: 0x13},
	0x6D: {Id: 0x6D, Size: 0x03},
	0x6E: {Id: 0x6E, Size: 0x0e},
	0x6F: {Id: 0x6F, Size: -1},
	0x70: {Id: 0x70, Size: 0x1c},
	0x71: {Id: 0x71, Size: -1},
	0x72: {Id: 0x72, Size: 0x05, Handler: &RequestWarModePacket{}},
	0x73: {Id: 0x73, Size: 0x02, Handler: &PingPacket{}},
	0x74: {Id: 0x74, Size: -1},
	0x75: {Id: 0x75, Size: 0x23},
	0x76: {Id: 0x76, Size: 0x10},
	0x77: {Id: 0x77, Size: 0x11, Handler: &UpdatePlayerPacket{}},
	0x78: {Id: 0x78, Size: -1},
	0x79: {Id: 0x79, Size: 0x09},
	0x7A: {Id: 0x7A, Size: -1},
	0x7B: {Id: 0x7B, Size: 0x02},
	0x7C: {Id: 0x7C, Size: -1},
	0x7D: {Id: 0x7D, Size: 0x0d},
	0x7E: {Id: 0x7E, Size: 0x02},
	0x7F: {Id: 0x7F, Size: -1},
	0x80: {Id: 0x80, Size: 0x3e, Handler: &AccountLoginRequestPacket{}},
	0x81: {Id: 0x81, Size: -1},
	0x82: {Id: 0x82, Size: 0x02},
	0x83: {Id: 0x83, Size: 0x27},
	0x84: {Id: 0x84, Size: 0x45},
	0x85: {Id: 0x85, Size: 0x02},
	0x86: {Id: 0x86, Size: -1},
	0x87: {Id: 0x87, Size: -1},
	0x88: {Id: 0x88, Size: 0x42},
	0x89: {Id: 0x89, Size: -1},
	0x8A: {Id: 0x8A, Size: -1},
	0x8B: {Id: 0x8B, Size: -1},
	0x8C: {Id: 0x8C, Size: 0x0b, Handler: &ServerRedirectPacket{}},
	0x8D: {Id: 0x8D, Size: -1},
	0x8E: {Id: 0x8E, Size: -1},
	0x8F: {Id: 0x8F, Size: -1},
	0x90: {Id: 0x90, Size: 0x13},
	0x91: {Id: 0x91, Size: 0x41, Handler: &PostLoginPacket{}},
	0x92: {Id: 0x92, Size: -1},
	0x93: {Id: 0x93, Size: 0x63},
	0x94: {Id: 0x94, Size: -1},
	0x95: {Id: 0x95, Size: 0x09},
	0x96: {Id: 0x96, Size: -1},
	0x97: {Id: 0x97, Size: 0x02},
	0x98: {Id: 0x98, Size: -1},
	0x99: {Id: 0x99, Size: 0x1a},
	0x9A: {Id: 0x9A, Size: -1},
	0x9B: {Id: 0x9B, Size: 0x102},
	0x9C: {Id: 0x9C, Size: 0x135},
	0x9D: {Id: 0x9D, Size: 0x33},
	0x9E: {Id: 0x9E, Size: -1},
	0x9F: {Id: 0x9F, Size: -1},
	0xA0: {Id: 0xA0, Size: 0x03, Handler: &ServerSelectPacket{}},
	0xA1: {Id: 0xA1, Size: 0x09, Handler: &HealthPacket{}},
	0xA2: {Id: 0xA2, Size: 0x09},
	0xA3: {Id: 0xA3, Size: 0x09},
	0xA4: {Id: 0xA4, Size: 0x95},
	0xA5: {Id: 0xA5, Size: -1},
	0xA6: {Id: 0xA6, Size: -1},
	0xA7: {Id: 0xA7, Size: 0x04},
	0xA8: {Id: 0xA8, Size: -1, Handler: &ServerListPacket{}},
	0xA9: {Id: 0xA9, Size: -1},
	0xAA: {Id: 0xAA, Size: 0x05},
	0xAB: {Id: 0xAB, Size: -1},
	0xAC: {Id: 0xAC, Size: -1},
	0xAD: {Id: 0xAD, Size: -1},
	0xAE: {Id: 0xAE, Size: -1},
	0xAF: {Id: 0xAF, Size: 0x0d},
	0xB0: {Id: 0xB0, Size: -1},
	0xB1: {Id: 0xB1, Size: -1},
	0xB2: {Id: 0xB2, Size: -1},
	0xB3: {Id: 0xB3, Size: -1},
	0xB4: {Id: 0xB4, Size: -1},
	0xB5: {Id: 0xB5, Size: 0x40},
	0xB6: {Id: 0xB6, Size: 0x09},
	0xB7: {Id: 0xB7, Size: -1},
	0xB8: {Id: 0xB8, Size: -1},
	0xB9: {Id: 0xB9, Size: 0x03},
	0xBA: {Id: 0xBA, Size: 0x06},
	0xBB: {Id: 0xBB, Size: 0x09},
	0xBC: {Id: 0xBC, Size: 0x03},
	0xBD: {Id: 0xBD, Size: -1},
	0xBE: {Id: 0xBE, Size: -1},
	0xBF: {Id: 0xBF, Size: -1, Handler: &GenericCommandPacket{}},
	0xC0: {Id: 0xC0, Size: 0x24},
	0xC1: {Id: 0xC1, Size: -1},
	0xC2: {Id: 0xC2, Size: -1},
	0xC3: {Id: 0xC3, Size: -1},
	0xC4: {Id: 0xC4, Size: 0x06},
	0xC5: {Id: 0xC5, Size: 0xcb},
	0xC6: {Id: 0xC6, Size: 0x01},
	0xC7: {Id: 0xC7, Size: 0x31},
	0xC8: {Id: 0xC8, Size: 0x02},
	0xC9: {Id: 0xC9, Size: 0x06},
	0xCA: {Id: 0xCA, Size: 0x06},
	0xCB: {Id: 0xCB, Size: 0x07},
	0xCC: {Id: 0xCC, Size: -1},
	0xCD: {Id: 0xCD, Size: 0x01},
	0xCE: {Id: 0xCE, Size: -1},
	0xCF: {Id: 0xCF, Size: 0x4e},
	0xD0: {Id: 0xD0, Size: -1},
	0xD1: {Id: 0xD1, Size: 0x02},
	0xD2: {Id: 0xD2, Size: 0x19},
	0xD3: {Id: 0xD3, Size: -1},
	0xD4: {Id: 0xD4, Size: -1},
	0xD5: {Id: 0xD5, Size: -1},
	0xD6: {Id: 0xD6, Size: -1, Handler: &MegaClilocPacket{}},
	0xD7: {Id: 0xD7, Size: -1},
	0xD8: {Id: 0xD8, Size: -1},
	0xD9: {Id: 0xD9, Size: 0x10c},
	0xDA: {Id: 0xDA, Size: -1},
	0xDB: {Id: 0xDB, Size: -1},
	0xDC: {Id: 0xDC, Size: 9, Handler: &RevisionPacket{}},
	0xDD: {Id: 0xDD, Size: -1},
	0xDE: {Id: 0xDE, Size: -1},
	0xDF: {Id: 0xDF, Size: -1},
	0xE0: {Id: 0xE0, Size: -1},
	0xE1: {Id: 0xE1, Size: 0x09},
	0xE2: {Id: 0xE2, Size: 0xa},
	0xE3: {Id: 0xE3, Size: 0x4d},
	0xE4: {Id: 0xE4, Size: -1},
	0xE5: {Id: 0xE5, Size: -1},
	0xE6: {Id: 0xE6, Size: -1},
	0xE7: {Id: 0xE7, Size: -1},
	0xE8: {Id: 0xE8, Size: -1},
	0xE9: {Id: 0xE9, Size: -1},
	0xEA: {Id: 0xEA, Size: -1},
	0xEB: {Id: 0xEB, Size: -1},
	0xEC: {Id: 0xEC, Size: -1},
	0xED: {Id: 0xED, Size: -1},
	0xEE: {Id: 0xEE, Size: -1},
	0xEF: {Id: 0xEF, Size: 0x15},
	0xF0: {Id: 0xF0, Size: -1},
	0xF1: {Id: 0xF1, Size: -1},
	0xF2: {Id: 0xF2, Size: -1},
	0xF3: {Id: 0xF3, Size: 0x18},
	0xF4: {Id: 0xF4, Size: -1},
	0xF5: {Id: 0xF5, Size: 0x15},
	0xF6: {Id: 0xF6, Size: -1},
	0xF7: {Id: 0xF7, Size: -1},
	0xF8: {Id: 0xF8, Size: 0x6a},
	0xF9: {Id: 0xF9, Size: -1},
	0xFA: {Id: 0xFA, Size: -1},
	0xFB: {Id: 0xFB, Size: -1},
	0xFC: {Id: 0xFC, Size: -1},
	0xFD: {Id: 0xFD, Size: -1},
	0xFE: {Id: 0xFE, Size: 0x8},
	0xFF: {Id: 0xFF, Size: -1},
}
